if [ ! "$1" ]; then
    echo "patched target(\$1) not defined"
    return 
else
    echo "patched target   = $1"
    patch_target=$1
fi

if [ ! "$2" ]; then
    echo "unpatched target(\$2) not defined"
    return 
else
    echo "unpatched target = $2"
    unpatch_target=$2
fi

if [ ! "$3" ]; then
    echo "aflgo crash_dir(\$3) not defined"
    return 
else
    echo "aflgo crash_dir  = $3"
    crash_dir=$3
fi

if [ "$4" ]; then
    echo "record only $4 real_crash"
    real_crash_record_cnt=$4
else
    echo "record only all real_crash"
    real_crash_record_cnt=114514
fi

if [ ! "$5" ]; then
    echo "timeout is set to 3s defaultly"
    time_out=3s 
else
    echo "timeout          = $5"
    time_out=3s
fi




asan_string="AddressSanitizer"
asan_string_pattern1="==ERROR: AddressSanitizer"
asan_string_pattern2="SUMMARY: AddressSanitizer:"


cd $crash_dir
rm real_crash.txt
crashes=$(ls)
for crashi in $crashes
do
    crash_patch=false
    crash_unpatch=false
    timeout -s INT $time_out $unpatch_target $crashi >/dev/null 2>&1
    code1=$?
    timeout -s INT $time_out $patch_target $crashi >/dev/null 2>&1
    code2=$?
    if [ $code1 > 0 ] && [ $code2 = 0 ]; then
        echo $code1 $code2
        echo $crashi >> real_crash.txt
        echo "[REAL_CRASH]: $crashi"
        real_crash_record_cnt=$real_crash_record_cnt-1
        if [[ real_crash_record_cnt -le 0 ]]; then
            break
        fi
    fi

done

echo "$crash_dir/real_crash.txt"
n=$(cat $crash_dir/real_crash.txt | wc -l)
echo "[REAL_CRASH NUMBER]: $n"