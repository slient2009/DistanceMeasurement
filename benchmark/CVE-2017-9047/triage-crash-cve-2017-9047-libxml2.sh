if [ ! "$1" ]; then
    echo "patched target(\$1) not defined"
    return 
else
    echo "patched target   = $1"
    patch_target=$1
fi

if [ ! "$2" ]; then
    echo "unpatched target(\$2) not defined"
    return 
else
    echo "unpatched target = $2"
    unpatch_target=$2
fi

if [ ! "$3" ]; then
    echo "aflgo crash_dir(\$3) not defined"
    return 
else
    echo "aflgo crash_dir  = $3"
    crash_dir=$3
fi

if [ "$4" ]; then
    echo "record only $4 real_crash"
    real_crash_record_cnt=$4
else
    echo "record only all real_crash"
    real_crash_record_cnt=114514
fi

# ./triage_crash_libxml2.sh /home/wenake/AFLGo-testcase/libxml2_ef709ce2/libxml2_ef709ce2_patched/xmllint /home/wenake/AFLGo-testcase/libxml2_ef709ce2/libxml2_ef709ce2_unpatched/xmllint /home/wenake/AFLGo-testcase/libxml2_ef709ce2/libxml2_ef709ce2_harmonic/obj-aflgo/out/out_0/ef709ce2/crashes
# patch_target="/home/wenake/AFLGo-testcase/cxxfilt-CVE-2016-4487/cxxfilt-CVE-2016-4487-patched/patch/binutils/cxxfilt"
# unpatch_target="/home/wenake/AFLGo-testcase/cxxfilt-CVE-2016-4487/cxxfilt-CVE-2016-4487-unpatched/unpatch/binutils/cxxfilt"

asan_string="AddressSanitizer"
asan_string_pattern1="==ERROR: AddressSanitizer"
asan_string_pattern2="SUMMARY: AddressSanitizer:"


cd $crash_dir
rm real_crash.txt
crashes=$(ls)
for crashi in $crashes
do
    crash_patch=false
    crash_unpatch=false
    out_lines=$($unpatch_target --valid --recover $crashi 2>&1 | grep $asan_string)
    if [[ $out_lines == *$asan_string_pattern1*$asan_string_pattern2* ]]; then
        crash_unpatch=true
    fi

    out_lines=$($patch_target --valid --recover $crashi 2>&1 | grep $asan_string)
    if [[ $out_lines == *$asan_string_pattern1*$asan_string_pattern2* ]]; then
        crash_patch=true
    fi

    if [ $crash_unpatch = true ] && [ $crash_patch = false ]; then
        if [[ real_crash_record_cnt -le 0 ]]; then
            break
        fi
        real_crash_record_cnt=$real_crash_record_cnt-1
        echo $crashi >> real_crash.txt
        echo "[REAL_CRASH]: $crashi"
    fi

done

echo "$crash_dir/real_crash.txt"
